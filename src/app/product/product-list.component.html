<div class="container mt-5">

  <!-- ====================== HEADER: Tiêu đề + Controls ====================== -->
  <div class="page-header">
    <!-- Bên trái: Tiêu đề + Filter thẳng hàng dọc -->
    <div class="left-column">
      <h2 class="mb-0">Danh sách sản phẩm</h2>
      <!-- Filter nằm thẳng hàng dọc với tiêu đề -->
      <div class="filter-section">
        <select class="form-select filter-select"
                [(ngModel)]="selectedCategory"
                (change)="onCategoryChange()">
          <option value="">Tất cả nhóm</option>
          <option value="Phụ kiện">Phụ kiện</option>
          <option value="Thực phẩm">Thực phẩm</option>
          <option value="Đồ uống">Đồ uống</option>
        </select>
      </div>
    </div>

    <!-- Bên phải: Search + Excel + Thêm mới cùng hàng ngang -->
    <div class="right-controls">
      <!-- 2. Thanh tìm kiếm có nút X -->
      <div class="input-group">
        <input type="text"
               class="form-control"
               placeholder="Tìm kiếm sản phẩm..."
               [(ngModel)]="searchTerm"
               (input)="onSearchChange()">
        <button class="btn btn-outline-secondary"
                type="button"
                (click)="clearSearch()"
                [class.opacity-0]="!searchTerm"
                title="Xóa tìm kiếm">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- 3. Nút Xuất Excel Dropdown -->
      <div class="dropdown excel-dropdown">
        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-file-earmark-excel"></i> Xuất Excel
        </button>
        <ul class="dropdown-menu">
          <li><button class="dropdown-item" (click)="exportCurrentPageToExcel()">
            <i class="bi bi-file-earmark-spreadsheet"></i> Xuất trang hiện tại
          </button></li>
          <li><button class="dropdown-item" (click)="exportFilteredToExcel()">
            <i class="bi bi-funnel"></i> Xuất kết quả lọc
          </button></li>
          <li><button class="dropdown-item" (click)="exportAllToExcel()">
            <i class="bi bi-file-earmark-excel"></i> Xuất tất cả
          </button></li>
        </ul>
      </div>

      <!-- 4. Nút Thêm mới -->
      <a routerLink="/product/add" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Thêm mới
      </a>
    </div>
  </div>

  <!-- ====================== BẢNG SẢN PHẨM ====================== -->
  <div class="table-wrapper">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Mã hàng</th>
          <th>Tên hàng</th>
          <th>Giá nhập</th>
          <th>Giá bán</th>
          <th>Mô tả</th>
          <th width="150">Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of products">
          <td>{{ p.code }}</td>
          <td>
            <!-- Tooltip ảnh khi hover tên sản phẩm -->
            <div class="product-name-cell" 
                 (mouseenter)="showImage(p)" 
                 (mouseleave)="hideImage()">
              <span class="product-name">{{ p.name }}</span>

              <!-- Tooltip ảnh hiện giữa màn hình -->
              <div class="product-image-tooltip" 
                   *ngIf="hoveredProduct && hoveredProduct.id === p.id && p.image">
                <img [src]="p.image" [alt]="p.name" class="tooltip-image">
              </div>
            </div>
          </td>
          <td>{{ p.importPrice | number:'1.0-0' }}</td>
          <td>{{ p.salePrice | number:'1.0-0' }}</td>
          <td class="text-truncate" style="max-width: 200px;">{{ p.description }}</td>
          <td>
            <div class="action-buttons">
              <a [routerLink]="['/product/edit', p.id]"
                 class="btn btn-warning btn-sm"
                 (click)="onEditClick(p)">Sửa</a>
              <button (click)="delete(p.id!)" 
                      class="btn btn-danger btn-sm">Xóa</button>
            </div>
          </td>
        </tr>

        <!-- Không có dữ liệu -->
        <tr *ngIf="products.length === 0">
          <td colspan="6" class="text-center py-5 text-muted">
            Chưa có sản phẩm nào
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ====================== PHÂN TRANG ====================== -->
  <div class="pagination-container" *ngIf="totalElements > 0">
    <div class="pagination-info text-muted">
      Hiển thị {{ (currentPage * pageSize) + 1 }} - {{ getEndIndex() }} của {{ totalElements }} sản phẩm
    </div>

    <nav aria-label="Product pagination" class="pagination-nav">
      <ul class="pagination mb-0">
        <!-- First Page -->
        <li class="page-item" [class.disabled]="isFirst">
          <button class="page-link" (click)="goToFirstPage()" [disabled]="isFirst" title="Trang đầu">
            <i class="bx bx-chevrons-left"></i>
          </button>
        </li>

        <!-- Previous Page -->
        <li class="page-item" [class.disabled]="isFirst">
          <button class="page-link" (click)="previousPage()" [disabled]="isFirst" title="Trang trước">
            <i class="bx bx-chevron-left"></i>
          </button>
        </li>

        <!-- Page Numbers -->
        <li class="page-item"
            *ngFor="let page of getPagesArray()"
            [class.active]="page === currentPage">
          <button class="page-link" (click)="goToPage(page)">{{ page + 1 }}</button>
        </li>

        <!-- Next Page -->
        <li class="page-item" [class.disabled]="isLast">
          <button class="page-link" (click)="nextPage()" [disabled]="isLast" title="Trang sau">
            <i class="bx bx-chevron-right"></i>
          </button>
        </li>

        <!-- Last Page -->
        <li class="page-item" [class.disabled]="isLast">
          <button class="page-link" (click)="goToLastPage()" [disabled]="isLast" title="Trang cuối">
            <i class="bx bx-chevrons-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>

</div>